name: Sysdig CI Scan (Voting App)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images (vote, worker, result)
        run: |
          docker build -t vote:${{ github.sha }} ./vote
          docker build -t worker:${{ github.sha }} ./worker
          docker build -t result:${{ github.sha }} ./result

      - name: Install Sysdig CLI Scanner (official path + checksum)
        run: |
          set -euo pipefail

          VERSION="$(curl -fsSL https://download.sysdig.com/scanning/sysdig-cli-scanner/latest_version.txt | tr -d '\n')"
          echo "Sysdig scanner version: ${VERSION}"

          BIN_URL="https://download.sysdig.com/scanning/bin/sysdig-cli-scanner/${VERSION}/linux/amd64/sysdig-cli-scanner"
          SHA_URL="https://download.sysdig.com/scanning/bin/sysdig-cli-scanner/${VERSION}/linux/amd64/sysdig-cli-scanner.sha256"

          echo "BIN_URL=${BIN_URL}"
          echo "SHA_URL=${SHA_URL}"

          curl -fsSL "$BIN_URL" -o sysdig-cli-scanner
          curl -fsSL "$SHA_URL" -o sysdig-cli-scanner.sha256

          # Verify checksum (runner is Ubuntu -> sha256sum exists)
          sha256sum -c sysdig-cli-scanner.sha256

          chmod +x ./sysdig-cli-scanner
          ls -lh sysdig-cli-scanner
          ./sysdig-cli-scanner --version
     
          
          
          

      - name: Scan images (requires token)
        env:
          SECURE_API_TOKEN: ${{ secrets.SYSDIG_SECURE_API_TOKEN }}
          SYSDIG_API_URL: ${{ secrets.SYSDIG_ENDPOINT }}
        run: |
          set -euo pipefail

          if [ -z "${SECURE_API_TOKEN:-}" ]; then
            echo "ERROR: Missing SYSDIG_SECURE_API_TOKEN GitHub secret (mapped to SECURE_API_TOKEN)"
            exit 1
          fi
          if [ -z "${SYSDIG_API_URL:-}" ]; then
            echo "ERROR: Missing SYSDIG_ENDPOINT GitHub secret (mapped to SYSDIG_API_URL)"
            exit 1
          fi

          fail=0

          ./sysdig-cli-scanner --apiurl "${SYSDIG_API_URL}" docker://vote:${{ github.sha }}   || fail=1
          ./sysdig-cli-scanner --apiurl "${SYSDIG_API_URL}" docker://worker:${{ github.sha }} || fail=1
          ./sysdig-cli-scanner --apiurl "${SYSDIG_API_URL}" docker://result:${{ github.sha }} || fail=1

          exit $fail



    
    
