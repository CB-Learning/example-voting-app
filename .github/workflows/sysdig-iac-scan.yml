name: Sysdig IaC Scan

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read

jobs:
  iac_scan:
    runs-on: ubuntu-latest

    env:
      SECURE_API_TOKEN: ${{ secrets.SECURE_API_TOKEN }}
      SYSDIG_API_URL: ${{ secrets.SYSDIG_API_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sysdig-cli-scanner
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ./bin

          VERSION="$(curl -fsSL https://download.sysdig.com/scanning/sysdig-cli-scanner/latest_version.txt | tr -d '\n')"
          BIN_URL="https://download.sysdig.com/scanning/bin/sysdig-cli-scanner/${VERSION}/linux/amd64/sysdig-cli-scanner"
          SHA_URL="https://download.sysdig.com/scanning/bin/sysdig-cli-scanner/${VERSION}/linux/amd64/sysdig-cli-scanner.sha256"

          curl -fsSL "$BIN_URL" -o ./bin/sysdig-cli-scanner
          curl -fsSL "$SHA_URL" -o ./bin/sysdig-cli-scanner.sha256

          (cd ./bin && sha256sum -c sysdig-cli-scanner.sha256)

          chmod +x ./bin/sysdig-cli-scanner
          ./bin/sysdig-cli-scanner --version


      - name: Sysdig IaC Scan
        shell: bash
        run: |
          set -euo pipefail
          echo "Token length: ${#SECURE_API_TOKEN}"
          ./bin/sysdig-cli-scanner --iac \
            --apiurl="${SYSDIG_API_URL}" \
            -r \
            -f high \
            .
